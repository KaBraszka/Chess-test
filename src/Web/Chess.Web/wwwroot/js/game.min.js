$(function(){function f(t,i,r,u){let f=document.createElement("li");f.innerText=`${t}`;r?f.classList.add("chat-internal-msg","chat-msg","flex-start"):u?f.classList.add("black-chat-msg","chat-user-msg","chat-msg","flex-end"):f.classList.add("white-chat-msg","chat-user-msg","chat-msg","flex-start");i.appendChild(f);i.scrollTop=n.gameChatWindow.scrollHeight}function c(n){let t=document.querySelectorAll(`.highlight-${n}`);for(let n=0;n<t.length;n++)t[n].className=t[n].className.replace(/\bhighlight\b/g,"")}function l(t){t==h?(n.statusText.innerText="Your turn!",n.statusText.style.color="green"):(n.statusText.innerText=`${t}'s turn!`,n.statusText.style.color="red")}function s(n){return new Promise(t=>setTimeout(t,n))}function v(n,i,r,u,f){if(e===0&&r.search(/b/)!==-1||e===1&&r.search(/w/)!==-1)return"snapback";if(i.length===2){let r=Chessboard.objToFen(f),e=Chessboard.objToFen(u);t.invoke("MoveSelected",n,i,r,e)}}var t=(new signalR.HubConnectionBuilder).withUrl("/hub").build(),a,r;let u,h,e,i,o;const n={playground:document.querySelector(".main-playground"),board:document.querySelector("#board"),statusText:document.querySelector(".status-bar-text"),statusCheck:document.querySelector(".status-bar-check-notification"),whiteName:document.querySelector(".main-playground-white-name"),whitePointsValue:document.querySelector(".white-points-value"),whiteRating:document.querySelector(".main-playground-white-rating"),whiteMoveHistory:document.querySelector(".main-playground-white-move-history"),blackPawnsTaken:document.querySelector(".taken-pieces-black-pawn-value"),blackKnightsTaken:document.querySelector(".taken-pieces-black-knight-value"),blackBishopsTaken:document.querySelector(".taken-pieces-black-bishop-value"),blackRooksTaken:document.querySelector(".taken-pieces-black-rook-value"),blackQueensTaken:document.querySelector(".taken-pieces-black-queen-value"),blackName:document.querySelector(".main-playground-black-name"),blackRating:document.querySelector(".main-playground-black-rating"),blackPointsValue:document.querySelector(".black-points-value"),blackMoveHistory:document.querySelector(".main-playground-black-move-history"),whitePawnsTaken:document.querySelector(".taken-pieces-white-pawn-value"),whiteKnightsTaken:document.querySelector(".taken-pieces-white-knight-value"),whiteBishopsTaken:document.querySelector(".taken-pieces-white-bishop-value"),whiteRooksTaken:document.querySelector(".taken-pieces-white-rook-value"),whiteQueensTaken:document.querySelector(".taken-pieces-white-queen-value"),gameChatWindow:document.querySelector(".game-chat-window"),lobbyChatWindow:document.querySelector(".game-lobby-chat-window"),rooms:document.querySelector(".game-lobby-room-container"),lobbyInputName:document.querySelector(".game-lobby-input-name"),lobbyInputCreateBtn:document.querySelector(".game-lobby-input-create-btn"),lobbyChatInput:document.querySelector(".game-lobby-chat-input"),lobbyChatSendBtn:document.querySelector(".game-lobby-chat-send-btn"),gameChatInput:document.querySelector(".game-chat-input"),gameChatSendBtn:document.querySelector(".game-chat-send-btn"),resignBtn:document.querySelector(".resign-btn"),offerDrawBtn:document.querySelector(".offer-draw-btn"),threefoldDrawBtn:document.querySelector(".threefold-draw-btn")};t.on("AddRoom",function(t){let i=document.createElement("div"),r=document.createElement("span"),u=document.createElement("button");r.innerText=`${t.name.toUpperCase()}'S ROOM`;r.classList.add("game-lobby-room-name");u.innerText="JOIN";u.classList.add("game-lobby-room-join-btn","game-btn","btn");i.append(r,u);i.classList.add(`${t.id}`);n.rooms.appendChild(i)});t.on("ListRooms",function(t){$(".game-lobby-room-container").empty();t.forEach(t=>{let i=document.createElement("div"),r=document.createElement("span"),u=document.createElement("button");r.innerText=`${t.name.toUpperCase()}'S ROOM`;r.classList.add("game-lobby-room-name");u.innerText="JOIN";u.classList.add("game-lobby-room-join-btn","game-btn","btn");i.append(r,u);i.classList.add(`${t.id}`);n.rooms.appendChild(i)})});t.on("Start",function(t){document.querySelector(".game-lobby").style.display="none";n.playground.style.display="flex";n.board.style.pointerEvents="auto";$(".game-btn").prop("disabled",!1);$(".threefold-draw-btn").prop("disabled",!0);e=u==t.player1.id?t.player1.color:t.player2.color;h=u==t.player1.id?t.player1.name:t.player2.name;i=t.player1.name;o=t.player2.name;n.whiteName.innerHTML=i;n.blackName.innerHTML=o;n.whiteRating.innerHTML=t.player1.rating;n.blackRating.innerHTML=t.player2.rating;l(t.movingPlayer.name)});t.on("BoardMove",function(n,t){r.move(`${n}-${t}`)});t.on("BoardSnapback",function(n){r.position(n)});t.on("BoardSetPosition",function(n){r.position(n)});t.on("EnPassantTake",function(n,t){r.move(`${t}-${n}`,`${n}-${t}`)});t.on("GameOver",function(t,i){n.statusText.style.color="purple";n.board.style.pointerEvents="none";switch(i){case 1:n.statusText.innerText=`CHECKMATE! ${t.name.toUpperCase()} WIN!`;n.statusCheck.style.display="none";break;case 2:n.statusText.innerText=`STALEMATE!`;break;case 3:n.statusText.innerText=`DRAW!`;break;case 4:n.statusText.innerText=`DECLARED THREEFOLD REPETITION DRAW BY ${t.name.toUpperCase()}!`;break;case 5:n.statusText.innerText=`FIVEFOLD REPETITION DRAW!`;break;case 6:n.statusText.innerText=`${t.name.toUpperCase()} RESIGNED!`;break;case 7:n.statusText.innerText=`${t.name.toUpperCase()} LEFT. YOU WIN!`;break;case 8:n.statusText.innerText=`FIFTY-MOVE DRAW!`}$(".option-btn").prop("disabled",!0)});t.on("ThreefoldAvailable",function(n){n?$(".threefold-draw-btn").prop("disabled",!1):$(".threefold-draw-btn").prop("disabled",!0)});t.on("CheckStatus",function(t){t==2?(n.statusCheck.style.display="inline",n.statusCheck.innerText="CHECK!"):n.statusCheck.style.display="none"});t.on("InvalidMove",function(t){n.statusText.style.color="red";switch(t){case 3:n.statusText.innerText="King is in check!";break;case 4:n.statusText.innerText="Will open a check!";break;default:n.statusText.innerText="Invalid Move!"}s(1200).then(()=>{n.statusText.innerText="Your Turn!",n.statusText.style.color="green"})});t.on("DrawOffered",function(i){let e=n.statusText.innerText,o=n.statusText.style.color,r=document.createElement("button");r.innerText="YES";r.classList.add("draw-offer-yes-btn","draw-offer-button","btn","btn-primary");let u=document.createElement("button");u.innerText="NO";u.classList.add("draw-offer-no-btn","draw-offer-button","btn","btn-primary");n.statusText.style.color="black";n.statusText.innerText=`${i.name} requested a draw! Do you accept?`;let f=document.createElement("div");f.classList.add("draw-offer-container");f.append(r,u);n.statusText.appendChild(f);r.addEventListener("click",function(){t.invoke("OfferDrawAnswer",!0);n.statusText.innerText=e;n.statusText.style.color=o});u.addEventListener("click",function(){t.invoke("OfferDrawAnswer",!1);n.statusText.innerText=e;n.statusText.style.color=o})});t.on("DrawOfferRejected",function(t){let i=n.statusText.innerText,r=n.statusText.style.color;n.statusText.style.color="black";n.statusText.innerText=`${t.name} rejected the offer!`;s(1500).then(()=>{n.statusText.style.color=r,n.statusText.innerText=i})});t.on("UpdateTakenFigures",function(t,r,u){if(t.name==i){n.whitePointsValue.innerText=u;switch(r){case"Pawn":n.blackPawnsTaken.innerText++;break;case"Knight":n.blackKnightsTaken.innerText++;break;case"Bishop":n.blackBishopsTaken.innerText++;break;case"Rook":n.blackRooksTaken.innerText++;break;case"Queen":n.blackQueensTaken.innerText++}}else{n.blackPointsValue.innerText=u;switch(r){case"Pawn":n.whitePawnsTaken.innerText++;break;case"Knight":n.whiteKnightsTaken.innerText++;break;case"Bishop":n.whiteBishopsTaken.innerText++;break;case"Rook":n.whiteRooksTaken.innerText++;break;case"Queen":n.whiteQueensTaken.innerText++}}});t.on("UpdateMoveHistory",function(t,r){let u=document.createElement("li");u.classList.add("list-group-item");u.innerText=r;t.name==i?(n.whiteMoveHistory.appendChild(u),n.whiteMoveHistory.getElementsByTagName("li").length>40&&n.whiteMoveHistory.removeChild(n.whiteMoveHistory.childNodes[0])):(n.blackMoveHistory.appendChild(u),n.blackMoveHistory.getElementsByTagName("li").length>40&&n.blackMoveHistory.removeChild(n.blackMoveHistory.childNodes[0]))});t.on("UpdateStatus",function(n){l(n)});t.on("HighlightMove",function(n,t,r){let u=document.getElementsByClassName("square-"+n),f=document.getElementsByClassName("square-"+t);r.name===i?(c("black"),u[0].className+=" highlight-white",f[0].className+=" highlight-white"):(c("white"),u[0].className+=" highlight-black",f[0].className+=" highlight-black")});t.on("UpdateGameChat",function(t,r){let u=r.name===i?!1:!0;f(t,n.gameChatWindow,!1,u)});t.on("UpdateGameChatInternalMessage",function(t){f(t,n.gameChatWindow,!0,!1)});t.on("UpdateLobbyChat",function(t){f(t,n.lobbyChatWindow,!1,!1)});t.on("UpdateLobbyChatInternalMessage",function(t){f(t,n.lobbyChatWindow,!0,!1)});t.start();window.addEventListener("beforeunload",function(n){o!==undefined&&(n.preventDefault(),n.returnValue="")});$(document).on("click",".game-lobby-room-join-btn",function(){let f=$(this).parent().attr("class"),i=n.lobbyInputName.value;i!==""?t.invoke("JoinRoom",i,f).then(n=>{u=n.id,r.orientation("black")}).catch(n=>alert(n)):n.lobbyInputName.focus()});n.lobbyInputCreateBtn.addEventListener("click",function(){let i=n.lobbyInputName.value;i!==""?t.invoke("CreateRoom",i).then(t=>{u=t.id,document.querySelector(".game-lobby").style.display="none",n.playground.style.display="flex",n.board.style.pointerEvents="none",$(".game-btn").prop("disabled",!0),n.whiteName.innerHTML=t.name,n.whiteRating.innerHTML=t.rating,n.blackName.innerHTML="?",n.blackRating.innerHTML="N/A",n.statusText.style.color="red",n.statusText.innerText="WAITING FOR OPPONENT..."}).catch(n=>alert(n)):n.lobbyInputName.focus()});n.threefoldDrawBtn.addEventListener("click",function(){t.invoke("ThreefoldDraw").catch(n=>alert(n))});n.offerDrawBtn.addEventListener("click",function(){let i=n.statusText.innerText,r=n.statusText.style.color;n.statusText.style.color="black";n.statusText.innerText=`Draw request sent!`;s(1500).then(()=>{n.statusText.style.color=r,n.statusText.innerText=i});t.invoke("OfferDrawRequest").catch(n=>alert(n))});n.resignBtn.addEventListener("click",function(){t.invoke("Resign").catch(n=>alert(n))});n.lobbyChatSendBtn.addEventListener("click",function(){let i=n.lobbyChatInput.value;i!==""?t.invoke("LobbySendMessage",i).then(n.lobbyChatInput.value="").catch(n=>alert(n)):n.lobbyChatInput.focus()});n.gameChatSendBtn.addEventListener("click",function(){let i=n.gameChatInput.value;i!==""?t.invoke("GameSendMessage",i).then(n.gameChatInput.value="").catch(n=>alert(n)):n.gameChatInput.focus()});n.lobbyChatInput.addEventListener("keyup",function(t){t.keyCode===13&&n.lobbyChatSendBtn.click()});n.gameChatInput.addEventListener("keyup",function(t){t.keyCode===13&&n.gameChatSendBtn.click()});a={pieceTheme:"img/chesspieces/wikipedia/{piece}.png",draggable:!0,dropOffBoard:"snapback",showNotation:!0,onDrop:v,moveSpeed:50,position:"start"};r=ChessBoard("board",a)});